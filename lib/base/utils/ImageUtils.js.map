{"version":3,"sources":["../../../src/base/utils/ImageUtils.js"],"names":["ImageUtils","url","ready","load","error","list","intervalId","tick","i","length","end","splice","stop","clearInterval","fnReady","onready","width","height","newWidth","newHeight","img","Image","src","complete","call","onerror","onload","push","setInterval"],"mappings":"AAAA;;;;;;;;;;IAEMA,U;;;;;;;+BACcC,G,EAAKC,K,EAAOC,I,EAAMC,K,EAAO;AACzC,UAAIC,OAAO,EAAX;AAAA,UACEC,aAAa,IADf;;;AAGE;AACAC,aAAO,SAAPA,IAAO,GAAY;AACjB,YAAIC,IAAI,CAAR;AACA,eAAOA,IAAIH,KAAKI,MAAhB,EAAwBD,GAAxB,EAA6B;AAC3BH,eAAKG,CAAL,EAAQE,GAAR,GAAcL,KAAKM,MAAL,CAAYH,GAAZ,EAAiB,CAAjB,CAAd,GAAoCH,KAAKG,CAAL,GAApC;AACD;AACD,SAACH,KAAKI,MAAN,IAAgBG,MAAhB;AACD,OAVH;;;AAYE;AACAA,aAAO,SAAPA,IAAO,GAAY;AACjBC,sBAAcP,UAAd;AACAA,qBAAa,IAAb;AACD,OAhBH;;AAkBA,UAAIQ,UAAU,SAAVA,OAAU,CAAUb,GAAV,EAAeC,KAAf,EAAsBC,IAAtB,EAA4BC,KAA5B,EAAmC;AAC/C,YAAIW,iBAAJ;AAAA,YAAaC,cAAb;AAAA,YAAoBC,eAApB;AAAA,YAA4BC,iBAA5B;AAAA,YAAsCC,kBAAtC;AACA,YAAIC,MAAM,IAAIC,KAAJ,EAAV;AACAD,YAAIE,GAAJ,GAAUrB,GAAV;;AAEA;AACA,YAAImB,IAAIG,QAAR,EAAkB;AAChBrB,gBAAMsB,IAAN,CAAWJ,GAAX,EAAgBA,GAAhB;AACAjB,kBAAQA,KAAKqB,IAAL,CAAUJ,GAAV,EAAeA,GAAf,CAAR;AACA;AACD;;AAEDJ,gBAAQI,IAAIJ,KAAZ;AACAC,iBAASG,IAAIH,MAAb;;AAEA;AACAG,YAAIK,OAAJ,GAAc,YAAY;AACxBrB,mBAASA,MAAMoB,IAAN,CAAWJ,GAAX,EAAgBA,GAAhB,CAAT;AACAL,mBAAQL,GAAR,GAAc,IAAd;AACAU,gBAAMA,IAAIM,MAAJ,GAAaN,IAAIK,OAAJ,GAAc,IAAjC;AACD,SAJD;;AAMA;AACAV,mBAAU,mBAAY;AACpBG,qBAAWE,IAAIJ,KAAf;AACAG,sBAAYC,IAAIH,MAAhB;AACA,cAAIC,aAAaF,KAAb,IAAsBG,cAAcF,MAApC;AACF;AACAC,qBAAWC,SAAX,GAAuB,IAFzB,EAGE;AACAjB,kBAAMsB,IAAN,CAAWJ,GAAX,EAAgBA,GAAhB;AACAL,qBAAQL,GAAR,GAAc,IAAd;AACD;AACF,SAVD;AAWAK;;AAEA;AACAK,YAAIM,MAAJ,GAAa,YAAY;AACvB;AACA;AACA,WAACX,SAAQL,GAAT,IAAgBK,UAAhB;;AAEAZ,kBAAQA,KAAKqB,IAAL,CAAUJ,GAAV,EAAeA,GAAf,CAAR;;AAEA;AACAA,gBAAMA,IAAIM,MAAJ,GAAaN,IAAIK,OAAJ,GAAc,IAAjC;AACD,SATD;;AAWA;AACA,YAAI,CAACV,SAAQL,GAAb,EAAkB;AAChBL,eAAKsB,IAAL,CAAUZ,QAAV;AACA;AACA,cAAIT,eAAe,IAAnB,EAAyBA,aAAasB,YAAYrB,IAAZ,EAAkB,EAAlB,CAAb;AAC1B;AACF,OAtDD;;AAwDA,aAAOO,QAAQb,GAAR,EAAaC,KAAb,EAAoBC,IAApB,EAA0BC,KAA1B,CAAP;AACD;;;;;;kBAGYJ,U","file":"ImageUtils.js","sourcesContent":["'use strict'\r\n\r\nclass ImageUtils {\r\n  static ImageReady(url, ready, load, error) {\r\n    let list = [],\r\n      intervalId = null,\r\n\r\n      // 用来执行队列\r\n      tick = function () {\r\n        var i = 0;\r\n        for (; i < list.length; i++) {\r\n          list[i].end ? list.splice(i--, 1) : list[i]();\r\n        };\r\n        !list.length && stop();\r\n      },\r\n\r\n      // 停止所有定时器队列\r\n      stop = function () {\r\n        clearInterval(intervalId);\r\n        intervalId = null;\r\n      };\r\n\r\n    let fnReady = function (url, ready, load, error) {\r\n      let onready, width, height, newWidth, newHeight;\r\n      let img = new Image();\r\n      img.src = url;\r\n\r\n      // 如果图片被缓存，则直接返回缓存数据\r\n      if (img.complete) {\r\n        ready.call(img, img);\r\n        load && load.call(img, img);\r\n        return;\r\n      };\r\n\r\n      width = img.width;\r\n      height = img.height;\r\n\r\n      // 加载错误后的事件\r\n      img.onerror = function () {\r\n        error && error.call(img, img);\r\n        onready.end = true;\r\n        img = img.onload = img.onerror = null;\r\n      };\r\n\r\n      // 图片尺寸就绪\r\n      onready = function () {\r\n        newWidth = img.width;\r\n        newHeight = img.height;\r\n        if (newWidth !== width || newHeight !== height ||\r\n          // 如果图片已经在其他地方加载可使用面积检测\r\n          newWidth * newHeight > 1024\r\n        ) {\r\n          ready.call(img, img);\r\n          onready.end = true;\r\n        };\r\n      };\r\n      onready();\r\n\r\n      // 完全加载完毕的事件\r\n      img.onload = function () {\r\n        // onload在定时器时间差范围内可能比onready快\r\n        // 这里进行检查并保证onready优先执行\r\n        !onready.end && onready();\r\n\r\n        load && load.call(img, img);\r\n\r\n        // IE gif动画会循环执行onload，置空onload即可\r\n        img = img.onload = img.onerror = null;\r\n      };\r\n\r\n      // 加入队列中定期执行\r\n      if (!onready.end) {\r\n        list.push(onready);\r\n        // 无论何时只允许出现一个定时器，减少浏览器性能损耗\r\n        if (intervalId === null) intervalId = setInterval(tick, 40);\r\n      };\r\n    };\r\n\r\n    return fnReady(url, ready, load, error);\r\n  }\r\n}\r\n\r\nexport default ImageUtils"]}